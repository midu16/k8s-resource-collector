# k8s-resource-collector

A Go-based tool that collects all Kubernetes API resources from an OpenShift/Kubernetes cluster and saves them as YAML files. This tool replicates the functionality of the shell script:

```bash
for r in $(oc api-resources --verbs=list,get -o name | sort -u); do
  echo "--- # Resource: $r" >> all-resources.yaml
  oc get "$r" --all-namespaces -o yaml >> all-resources.yaml 2>/dev/null
done
```

## Features

- **Three Collection Modes**:
  - Directory mode: Creates individual YAML files for each resource type
  - Single file mode: Creates one file with all resources (like the original script)
  - Import mode: Splits existing all-resources.yaml files into individual ClusterResource files
- **Flexible Configuration**: Supports `--kubeconfig` flag or `KUBECONFIG` environment variable
- **Verbose Logging**: Optional detailed output during collection
- **Clean Mode**: Option to clean output directories before collection
- **Cross-Platform**: Works on Linux, macOS, and Windows
- **Container Support**: Includes Dockerfile for containerized deployment
- **No External Dependencies**: Uses only standard library packages

## Project Structure

```
k8s-resource-collector/
├── bin/                           # Binary output directory
│   └── k8s-resource-collector    # Compiled binary
├── cmd/                          # Source code
│   ├── main.go                   # Original Cobra-based main.go
│   ├── main.go.backup           # Backup of original main.go
│   ├── main_simple.go           # Simplified version with Kubernetes client-go
│   └── main_standalone.go       # ✅ Working standalone version (recommended)
├── internal/                     # Internal packages (empty for now)
├── output/                       # Default output directory
├── output-custom/                # Custom output directory
├── output-import/                # Import mode output directory
├── Dockerfile                    # Container build file
├── Makefile                      # Build system
├── go.mod                        # Go module dependencies
├── go.sum                        # Dependency checksums
├── README.md                     # This file
└── run-container-example.sh     # Container run example
```

## Quick Start

### Build and Run

```bash
# Build the binary
make build

# Show help
./bin/k8s-resource-collector --help

# Collect resources to individual files
./bin/k8s-resource-collector --verbose --output ./output

# Collect all resources to a single file (like original script)
./bin/k8s-resource-collector --single-file --output-file ./output/all-resources.yaml

# Use with custom kubeconfig
./bin/k8s-resource-collector --kubeconfig /path/to/kubeconfig --verbose

# Import and split existing all-resources.yaml file
./bin/k8s-resource-collector --import all-resources.yaml --verbose
```

### Available Versions

The project includes multiple versions of the main.go file:

1. **`main_standalone.go`** (✅ **Recommended**): Uses only standard library packages and executes `oc`/`kubectl` commands directly. No external dependencies required.

2. **`main_simple.go`**: Uses Kubernetes client-go libraries for direct API access.

3. **`main.go`**: Original Cobra-based version with full modular architecture.

## Usage Examples

### Directory Mode
Creates individual YAML files for each resource type:
```bash
./bin/k8s-resource-collector --verbose --output ./output
```

Output:
```
output/
├── pods.yaml
├── services.yaml
├── configmaps.yaml
├── deployments.yaml
└── ...
```

### Single File Mode
Creates one file with all resources (replicates original script):
```bash
./bin/k8s-resource-collector --single-file --output-file ./output/all-resources.yaml
```

Output:
```yaml
--- # Resource: pods
apiVersion: v1
kind: List
items:
- apiVersion: v1
  kind: Pod
  metadata:
    name: example-pod
    namespace: default
  ...
---
--- # Resource: services
apiVersion: v1
kind: List
items:
- apiVersion: v1
  kind: Service
  metadata:
    name: example-service
    namespace: default
  ...
---
```

### Import Mode
Splits existing all-resources.yaml files into individual ClusterResource files:
```bash
./bin/k8s-resource-collector --import all-resources.yaml --verbose
```

Output:
```
output-import/
├── pods.yaml
├── services.yaml
├── configmaps.yaml
├── deployments.yaml
└── ...
```

Each file contains the ClusterResource data with proper headers:
```yaml
# Generated by k8s-resource-collector
# Generated at: 2025-09-10T17:52:20+02:00
# Resource: pods
# ---

apiVersion: v1
kind: List
items:
- apiVersion: v1
  kind: Pod
  metadata:
    name: example-pod
    namespace: default
  ...
```

### Verbose Output
```bash
./bin/k8s-resource-collector --verbose --output ./output
```

Output:
```
Starting resource collection to directory: ./output
Collecting resource: pods
  pods: SUCCESS - Saved to ./output/pods.yaml
Collecting resource: services
  services: SUCCESS - Saved to ./output/services.yaml

=== Collection Summary ===
Successfully collected: 45 resources
Errors encountered: 2 resources
Output directory: ./output
Duration: 2m30s
========================
```

## Command Line Options

- `--kubeconfig`: Path to kubeconfig file (default: $KUBECONFIG or ~/.kube/config)
- `--output`: Output directory for collected resources (default: "./output")
- `--file`: Output file for single file mode
- `--verbose`: Enable verbose output
- `--single-file`: Collect all resources to a single YAML file
- `--clean`: Clean output directory before collection

## Container Usage

### Build Container
```bash
docker build -t k8s-resource-collector .
```

### Run Container
```bash
# Directory mode
docker run --rm \
  -v "$KUBECONFIG:/root/.kube/config:ro" \
  -v "$(pwd)/output:/app/output" \
  k8s-resource-collector \
  --verbose --output /app/output

# Single file mode
docker run --rm \
  -v "$KUBECONFIG:/root/.kube/config:ro" \
  -v "$(pwd)/output:/app/output" \
  k8s-resource-collector \
  --single-file --output-file /app/output/all-resources.yaml
```

### Using the Example Script
```bash
chmod +x run-container-example.sh
./run-container-example.sh
```

## Development

### Build System
```bash
# Build binary
make build

# Build for multiple platforms
make build-all

# Test binary
make test-binary

# Clean build artifacts
make clean

# Show all available targets
make help
```

### Testing
```bash
# Test the binary
make test-binary
```

## Requirements

- Go 1.21+
- `oc` or `kubectl` command available in PATH
- Access to a Kubernetes/OpenShift cluster
- Valid kubeconfig file

## License

This project is licensed under the MIT License - see the LICENSE file for details.

## Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests if applicable
5. Submit a pull request

## Troubleshooting

### Network Issues
If you encounter network issues when building with external dependencies, use the standalone version:
```bash
go build -o bin/k8s-resource-collector ./cmd/main_standalone.go
```

### Permission Issues
Ensure the tool has proper permissions to read the kubeconfig file and write to the output directory.

### Command Not Found
Make sure `oc` or `kubectl` is installed and available in your PATH.
